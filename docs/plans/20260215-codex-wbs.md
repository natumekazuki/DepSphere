# Codex前提WBS（最小スコープ確定版）

## Goal
- 静的コード解析で依存関係と重みを算出する。
- 依存関係を3Dグラフで可視化する。
- グラフのクリックから内蔵エディタビューアでコードを閲覧する。
- クラス移動（namespace/ファイル/プロジェクト間）を実行し、グラフへ自動リアルタイム反映する。

## 開発方針
- 本プロジェクトは **TDD（Test-Driven Development）を標準方針** とする。
- 実装は `失敗するテスト作成 -> 最小実装 -> リファクタ` の順で進める。
- WBS-02 以降の各機能は、受入条件に対応するテストが先に追加されていることを完了条件に含める。

## 本書の対象（これ以外は対象外）
- 対象機能は以下の4点のみ。
  - 静的解析（依存 + 重み）
  - 3Dグラフ可視化
  - 内蔵ビューア連携
  - クラス移動 + リアルタイム追随
- 上記以外の要件は本WBSから除外する。

## Design Doc要否チェック
- 判定: **必須**
- 作成対象:
  - `docs/design/dep-visualizer-core.md`
  - `docs/design/refactor-move-class-spec.md`
  - `docs/design/realtime-update-spec.md`

## Task List（チェックリスト）
- [x] WBS-01: 仕様固定（4機能の受入条件を確定）
- [x] WBS-02: 静的解析実装（依存関係 + 重み算出、テスト先行）
- [x] WBS-03: 3Dグラフ実装（表示/選択/フォーカス、テスト先行）
- [x] WBS-04: 内蔵ビューア実装（クリック連動でコード表示、テスト先行）
- [ ] WBS-05: クラス移動実装（namespace/ファイル/プロジェクト間、テスト先行）
- [ ] WBS-06: リアルタイム追随実装（監視 + 増分再解析 + グラフ更新、テスト先行）
- [ ] WBS-07: 結合試験（4機能の一連動作）

## WBS

| ID | タスク | 主担当 | 工数(人日) | 依存 | 完了条件 |
| :-- | :-- | :-- | :--: | :-- | :-- |
| WBS-01 | 仕様固定（受入条件定義） | 人手主導 + Codex補助 | 0.5-1 | - | 4機能の受入条件が確定 |
| WBS-02 | 静的解析（依存 + 重み） | Codex主導 | 6-10 | WBS-01 | Type単位の依存と重みを算出でき、抽出規則の単体テストが先行整備されている |
| WBS-03 | 3Dグラフ表示 | 人手主導 + Codex補助 | 5-8 | WBS-02 | 依存グラフを3Dで探索でき、主要操作のUIテストがある |
| WBS-04 | 内蔵ビューア連携 | Codex主導 | 3-6 | WBS-03 | ノードクリックで対象コードを閲覧でき、連携テストがある |
| WBS-05 | クラス移動（3種対応） | 人手主導 + Codex補助 | 10-18 | WBS-04 | namespace/ファイル/プロジェクト間移動が実行でき、失敗系テストでロールバックを検証済み |
| WBS-06 | 自動リアルタイム追随 | Codex主導 | 6-11 | WBS-05 | 移動/変更後にグラフが自動更新され、イベント入力に対する差分更新テストがある |
| WBS-07 | 結合試験・修正 | 人手主導 + Codex補助 | 3-6 | WBS-02..06 | 4機能が連続動作し破綻しない |

## 工数サマリ
- 合計: **33.5-60人日**

## 期間目安
- 1名 + Codex: **約1.7-3.0か月**
- 2名 + Codex: **約1.2-2.1か月**

## 受入基準
- A1: `.sln/.csproj` から静的依存関係と重みを算出できる。
- A2: 依存関係を3Dグラフで表示し、ノード選択できる。
- A3: ノードクリックで内蔵ビューアに対象コードが表示される。
- A4: クラス移動（namespace/ファイル/プロジェクト間）を実行できる。
- A5: クラス移動後、グラフが自動で追随更新される。

## Affected Files
- `docs/plans/20260215-codex-wbs.md`（本ファイル）
- `docs/design/dep-visualizer-core.md`（新規予定）
- `docs/design/refactor-move-class-spec.md`（新規予定）
- `docs/design/realtime-update-spec.md`（新規予定）

## Risks
- プロジェクト間移動は参照整合性を壊しやすく、失敗時対策が必要。
- リアルタイム追随は更新頻度過多でUI負荷が上がる可能性がある。
- 静的解析のみのため、実行時ホットパスは推定に留まる。

## Notes / Logs
- 2026-02-15: 4機能に限定した最小スコープWBSへ全面再作成。
- 2026-02-15: 詳細設計書（core/move-class/realtime-update）初版を作成。
- 2026-02-15: プロジェクト方針としてTDDを明記し、WBS完了条件へ反映。
- 2026-02-15: WBS-02着手。依存抽出（reference/inherit/implement）の先行テスト3件を追加し、最小実装でテスト通過。
- 2026-02-15: WBS-02進捗。重みメトリクス（Method/Statement/Branch/CallSite/FanOut/InDegree）と合成スコア算出を実装し、テスト1件追加で通過。
- 2026-02-15: WBS-02完了。`.sln/.csproj` 入力API（AnalyzePathAsync）を追加し、パス解析テスト2件を追加して通過。
- 2026-02-15: WBS-03着手。3D描画入力DTO（GraphView）と変換/JSON化をTDDで追加し、テスト2件を追加して通過。
- 2026-02-15: WBS-03進捗。Three.jsベースHTML生成、ノード選択メッセージ解析、WebView2ホスト骨組み（Windows条件付き）をTDDで追加。
- 2026-02-15: WBS-03完了。フォーカス操作（HTML関数 + 実行スクリプト生成 + ホスト呼び出し）を追加し、関連テストを通過。
- 2026-02-15: WBS-04着手。ノード位置情報（SourceLocation）をグラフへ保持し、ノードIDからソース断片を開く `SourceCodeViewer` をTDDで追加。
- 2026-02-15: WBS-04完了。ノード選択メッセージからソース表示へ接続する `GraphSelectionCoordinator` と、読み取り専用ビューアHTML生成を追加。
- 2026-02-15: WBS-05着手。`ClassMover.MoveNamespaceAsync` を追加し、namespace移動後の再解析追随テストを通過。
